

class CreateAdminWindow:
    """Create new admin account window"""
    
    def __init__(self, parent, db_manager):
        """
        Initialize create admin window
        
        Args:
            parent: Parent Tkinter window
            db_manager: DatabaseManager instance
        """
        self.parent = parent
        self.db_manager = db_manager
        
        # Create new window
        self.window = tk.Toplevel(parent)
        self.window.title("Create Admin Account - EVSU-OC ALIBLOG")
        self.window.geometry("500x400")
        self.window.configure(bg="#34495e")
        
        # Maximize by default (best-effort)
        try:
            self.window.state('zoomed')
        except Exception:
            pass

        # Center window
        self.center_window(500, 400)
        
        # Variables
        self.username_var = tk.StringVar()
        self.password_var = tk.StringVar()
        self.confirm_var = tk.StringVar()
        
        self.create_widgets()
    
    def center_window(self, width, height):
        """Center the window on screen"""
        screen_width = self.window.winfo_screenwidth()
        screen_height = self.window.winfo_screenheight()
        x = (screen_width - width) // 2
        y = (screen_height - height) // 2
        self.window.geometry(f"{width}x{height}+{x}+{y}")
    
    def create_widgets(self):
        """Create form widgets for admin creation"""
        
        # Back button in upper-left
        back_btn = tk.Button(
            self.window,
            text="← Back",
            font=("Arial", 11, "bold"),
            bg="#95a5a6",
            fg="white",
            cursor="hand2",
            command=lambda: [self.window.destroy(), AdminLoginWindow(self.parent, self.db_manager)]
        )
        back_btn.pack(anchor=tk.NW, padx=10, pady=5)
        
        # Title
        title_frame = tk.Frame(self.window, bg="#27ae60", pady=30)
        title_frame.pack(fill=tk.X)
        
        title_label = tk.Label(
            title_frame,
            text="➕ CREATE ADMIN ACCOUNT",
            font=("Arial", 24, "bold"),
            bg="#27ae60",
            fg="white"
        )
        title_label.pack()
        
        # Form frame
        form_frame = tk.Frame(self.window, bg="#34495e")
        form_frame.pack(expand=True, pady=30)
        
        # Username
        username_label = tk.Label(
            form_frame,
            text="Username:",
            font=("Arial", 12, "bold"),
            bg="#34495e",
            fg="white"
        )
        username_label.grid(row=0, column=0, sticky=tk.W, pady=10, padx=10)
        
        username_entry = tk.Entry(
            form_frame,
            textvariable=self.username_var,
            font=("Arial", 12),
            width=25,
            height=2
        )
        username_entry.grid(row=0, column=1, pady=10, padx=10)
        username_entry.focus_set()
        
        # Password
        password_label = tk.Label(
            form_frame,
            text="Password:",
            font=("Arial", 12, "bold"),
            bg="#34495e",
            fg="white"
        )
        password_label.grid(row=1, column=0, sticky=tk.W, pady=10, padx=10)
        
        password_entry = tk.Entry(
            form_frame,
            textvariable=self.password_var,
            font=("Arial", 12),
            width=25,
            height=2,
            show="●"
        )
        password_entry.grid(row=1, column=1, pady=10, padx=10)
        
        # Confirm Password
        confirm_label = tk.Label(
            form_frame,
            text="Confirm Password:",
            font=("Arial", 12, "bold"),
            bg="#34495e",
            fg="white"
        )
        confirm_label.grid(row=2, column=0, sticky=tk.W, pady=10, padx=10)
        
        confirm_entry = tk.Entry(
            form_frame,
            textvariable=self.confirm_var,
            font=("Arial", 12),
            width=25,
            height=2,
            show="●"
        )
        confirm_entry.grid(row=2, column=1, pady=10, padx=10)
        
        # Create button
        create_btn = tk.Button(
            form_frame,
            text="✅ CREATE ACCOUNT",
            font=("Arial", 12, "bold"),
            bg="#27ae60",
            fg="white",
            activebackground="#229954",
            activeforeground="white",
            width=20,
            height=2,
            cursor="hand2",
            command=self.create_account
        )
        create_btn.grid(row=3, column=0, columnspan=2, pady=20)
        
        # Footer with minimize button
        footer_frame = tk.Frame(self.window, bg="#34495e")
        footer_frame.pack(side=tk.BOTTOM, fill=tk.X, pady=10)

        minimize_btn = tk.Button(
            footer_frame,
            text="➖ Minimize",
            font=("Arial", 10),
            bg="#95a5a6",
            fg="white",
            cursor="hand2",
            command=lambda: self.window.iconify()
        )
        minimize_btn.pack(side=tk.RIGHT, padx=10)
    
    def create_account(self):
        """Create a new admin account"""
        username = self.username_var.get().strip()
        password = self.password_var.get().strip()
        confirm = self.confirm_var.get().strip()
        
        # Validate input
        if not username:
            messagebox.showerror("Validation Error", "Please enter a username.")
            return
        
        if len(username) < 3:
            messagebox.showerror("Validation Error", "Username must be at least 3 characters.")
            return
        
        if not password:
            messagebox.showerror("Validation Error", "Please enter a password.")
            return
        
        if len(password) < 6:
            messagebox.showerror("Validation Error", "Password must be at least 6 characters.")
            return
        
        if password != confirm:
            messagebox.showerror("Validation Error", "Passwords do not match.")
            return
        
        # Try to create the account
        try:
            conn = self.db_manager.get_connection()
            cursor = conn.cursor()
            
            cursor.execute("""
                INSERT INTO admin_accounts (username, password)
                VALUES (?, ?)
            """, (username, password))
            
            conn.commit()
            conn.close()
            
            messagebox.showinfo("Success", f"Admin account '{username}' created successfully!")
            self.window.destroy()
            AdminLoginWindow(self.parent, self.db_manager)
        
        except sqlite3.IntegrityError:
            messagebox.showerror("Error", f"Username '{username}' already exists.")
        except Exception as e:
            messagebox.showerror("Error", f"Failed to create admin account:\n{e}")
